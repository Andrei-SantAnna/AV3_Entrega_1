# proxy/nginx.conf

# O bloco 'events' é necessário, mesmo que vazio.
events {}

http {
    # 1. Definir o formato de log 'debug' solicitado 
    # $upstream_addr armazena para qual servidor backend a requisição foi
    log_format debug '$remote_addr [$time_local] "$request" -> $status $body_bytes_sent '
                     '"$http_referer" "$http_user_agent" -> $upstream_addr';

    # 2. Definir o grupo de servidores backend (web1, web2, web3) 
    upstream backend_servers {
        
        # Estratégia 1: Round Robin (Padrão) 
        # Nenhuma diretiva extra é necessária.
        
        # Estratégia 2: Least Connections 
        # Descomente a linha abaixo para usar:
        # least_conn;

        # Estratégia 3: IP Hash [cite: 22, 175]
        # Descomente a linha abaixo para usar:
         ip_hash;

        # Lista dos servidores. Os nomes 'web1', 'web2', 'web3'
        # serão resolvidos pelo Docker Compose.
        server web1:8000;
        server web2:8000;
        server web3:8000;
    }

    server {
        # 3. O proxy escuta na porta 80 
        listen 80;

        # 4. Configurar logs de acesso para usar o formato 'debug' 
        access_log /var/log/nginx/access.log debug;

        # 5. Para qualquer requisição (/), encaminhe para o grupo 'backend_servers' 
        location / {
            proxy_pass http://backend_servers;
            
            # Cabeçalhos recomendados para passar a informação do cliente real
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}